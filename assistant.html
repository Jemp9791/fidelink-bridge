<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FideLink Assistant â€” FULL + Rubros</title>
<meta name="theme-color" content="#0ea5e9"/>
<style>
  :root{--bg:#0b1020;--card:#0f172a;--border:#1f2a44;--ink:#e2e8f0;--mut:#94a3b8}
  *{box-sizing:border-box} body{font-family:system-ui,Roboto,Segoe UI,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
  .wrap{max-width:960px;margin:0 auto;padding:20px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin:12px 0}
  .title{display:flex;align-items:center;gap:12px}
  .pill{display:inline-block;background:#1f2a44;color:#cbd5e1;border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
  .row{display:grid;gap:10px}
  .row2{grid-template-columns:1fr 1fr}
  .row3{grid-template-columns:1fr 1fr 1fr}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1329;color:var(--ink)}
  .btn{background:#38bdf8;color:#00131a;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
  .btn.sec{background:#10b981;color:#052}
  .btn.warn{background:#f59e0b;color:#210}
  .mic{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border-radius:999px;border:0;background:#10b981;color:#042;cursor:pointer;font-weight:800}
  .mic.rec{background:#f59e0b;color:#120}
  .muted{color:var(--mut);font-size:12px}
  .out{white-space:pre-wrap}
  .item{padding:12px;border:1px solid var(--border);border-radius:12px;margin-bottom:10px}
  .actions{display:grid;gap:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <img alt="FideLink" width="36" height="36"
      src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect width='100%' height='100%' rx='8' fill='%231f2a44'/><text x='50%' y='58%' text-anchor='middle' font-family='Arial' font-size='14' fill='%23cbd5e1'>FL</text></svg>"/>
    <h1 style="margin:0">FideLink Assistant</h1>
    <span class="pill">FULL + Rubros</span>
  </div>

  <!-- Config -->
  <div class="card">
    <div class="row row3">
      <div>
        <label>API URL (Web App /exec)</label>
        <input id="api" placeholder="https://script.google.com/macros/s/XXXXX/exec"/>
        <small class="muted">Si estÃ¡ vacÃ­o o falla, usa <b>modo demo</b>.</small>
      </div>
      <div>
        <label>WhatsApp del comercio (solo dÃ­gitos)</label>
        <input id="wa" placeholder="54911..."/>
      </div>
      <div>
        <label>Rubro</label>
        <select id="rubro">
          <option value="generico">GenÃ©rico</option>
          <option value="panaderia">PanaderÃ­a</option>
          <option value="indumentaria">Indumentaria</option>
          <option value="gastronomia">GastronomÃ­a</option>
          <option value="electronica">ElectrÃ³nica</option>
          <option value="peluqueria">PeluquerÃ­a/EstÃ©tica</option>
          <option value="farmacia">Farmacia</option>
          <option value="fitness">Fitness/Deportes</option>
          <option value="libreria">LibrerÃ­a/RegalerÃ­a</option>
          <option value="servicios">Servicios</option>
          <option value="mascotas">Mascotas</option>
        </select>
      </div>
    </div>
    <div class="row row2" style="margin-top:10px">
      <div>
        <label>Idioma</label>
        <select id="lang">
          <option value="es-AR">EspaÃ±ol (AR)</option>
          <option value="es-ES">EspaÃ±ol (ES)</option>
          <option value="pt-BR">PortuguÃªs (BR)</option>
        </select>
      </div>
      <div>
        <label>MÃ©todo</label>
        <div class="row" style="grid-template-columns:1fr 1fr">
          <button id="btnMic" class="mic">ğŸ¤ Hablar</button>
          <button id="btnClear" class="btn warn">ğŸ§¹ Limpiar</button>
        </div>
      </div>
    </div>
    <div style="margin-top:10px">
      <label>Entrada por texto</label>
      <div class="row" style="grid-template-columns:1fr auto">
        <input id="textIn" placeholder='Ej: "Â¿QuiÃ©n cumple hoy?" / "Â¿QuÃ© promos esta semana?" / "Enviar agradecimiento a Ana por 15000"'/>
        <button id="btnSend" class="btn">â–¶ï¸ Enviar</button>
      </div>
      <div class="muted" id="hint">Sugerencias: â€œÂ¿QuiÃ©n cumple hoy?â€, â€œÂ¿QuÃ© promos esta semana?â€, â€œRecibiste tickets hoy?â€, â€œEnviar agradecimiento a Ana por 15000â€.</div>
    </div>
  </div>

  <!-- Vistas -->
  <div class="card"><div class="pill">Lo que dijiste/escribiste</div><div id="heard" class="out">â€”</div></div>
  <div class="card"><div class="pill">Respuesta</div><div id="resp" class="out">â€”</div></div>
  <div class="card"><div class="pill">Acciones</div><div id="actions" class="actions"></div></div>

  <!-- Promos simples (local, sin Sheets) -->
  <div class="card">
    <div class="pill">Promos</div>
    <div class="actions">
      <button class="btn sec" id="btnNewPromo">â• Crear promo</button>
    </div>
    <div id="promoBox" class="out muted">No hay promos cargadas aÃºn.</div>
  </div>

  <p class="muted">Consejo: â€œAgregar a pantalla de inicioâ€ para usarlo como app.</p>
</div>

<script>
/*** Helpers + Persistencia ***/
const $ = s => document.querySelector(s);
const enc = encodeURIComponent;
const digits = s => String(s||'').replace(/\D/g,'');
const LS = { api:'fl_api', wa:'fl_wa', lang:'fl_lang', rubro:'fl_rubro', promos:'fl_promos' };
$('#api').value = localStorage.getItem(LS.api)||'';
$('#wa').value = localStorage.getItem(LS.wa)||'';
$('#lang').value = localStorage.getItem(LS.lang)||'es-AR';
$('#rubro').value = localStorage.getItem(LS.rubro)||'generico';
$('#api').addEventListener('input', ()=>localStorage.setItem(LS.api, $('#api').value.trim()));
$('#wa').addEventListener('input', ()=>localStorage.setItem(LS.wa, digits($('#wa').value)));
$('#lang').addEventListener('change',()=>localStorage.setItem(LS.lang,$('#lang').value));
$('#rubro').addEventListener('change',()=>localStorage.setItem(LS.rubro,$('#rubro').value));

/*** Voz de salida ***/
const speak = (text) => { try{ const u=new SpeechSynthesisUtterance(text); u.lang=$('#lang').value||'es-AR'; speechSynthesis.speak(u);}catch(e){} };

/*** Reconocimiento de voz ***/
let rec=null;
function startRec(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ alert('Este navegador no soporta micrÃ³fono. UsÃ¡ Chrome (Android) o Safari (iPhone).'); return; }
  rec = new SR();
  rec.lang = $('#lang').value || 'es-AR';
  rec.interimResults = false; rec.maxAlternatives = 1;
  $('#btnMic').classList.add('rec'); $('#heard').textContent = 'Escuchando...';
  rec.onresult = (e)=>{ const txt = e.results[0][0].transcript; $('#heard').textContent = txt; routeCommand(txt); };
  rec.onerror = ()=>{ $('#heard').textContent = 'No te escuchÃ©. ProbÃ¡ de nuevo.'; $('#btnMic').classList.remove('rec'); };
  rec.onend = ()=> $('#btnMic').classList.remove('rec');
  rec.start();
}
$('#btnMic').addEventListener('click', startRec);
$('#btnClear').addEventListener('click', ()=>{ $('#heard').textContent='â€”'; $('#resp').textContent='â€”'; $('#actions').innerHTML=''; });

/*** Texto como alternativa ***/
$('#btnSend').addEventListener('click', ()=>{ const t=$('#textIn').value.trim(); if(!t) return; $('#heard').textContent=t; routeCommand(t); });
$('#textIn').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#btnSend').click(); } });

/*** DEMO/LOCAL handlers (si no hay API o falla) ***/
function handleCumples_demo(){
  $('#resp').textContent = 'Buscando cumpleaÃ±eros de hoy...'; $('#actions').innerHTML='';
  const list = [
    { name:'Ana PÃ©rez', phone:'5491112345678', textSuggested:'ğŸ‰ Â¡Feliz cumple, Ana! Te esperamos con un mimo especial.' },
    { name:'Juan GÃ³mez', phone:'5491198765432', textSuggested:'ğŸ‰ Â¡Feliz cumple, Juan! PasÃ¡ a buscar tu regalo.' }
  ];
  const t = `Hoy cumplen: ${list.map(x=>x.name).join(', ')}.`; $('#resp').textContent=t; speak(t);
  list.forEach(x=>{ renderActions([{ label:`ğŸ‚ Saludar a ${x.name}`, href: buildWaLink(x.phone, x.textSuggested) }]); });
}
function handlePromos_demo(){
  $('#resp').textContent = 'Revisando prÃ³ximas promociones y feriados...'; $('#actions').innerHTML='';
  const wa = $('#wa').value;
  const list = [
    { event:'DÃ­a del Amigo', date:'2025-07-20', messageSuggested:'ğŸ‘¯â€â™€ï¸ Promo DÃ­a del Amigo: 2x1 en picadas ğŸ§€ğŸ‰' },
    { event:'Finde Largo', date:'2025-10-20', messageSuggested:'ğŸ—“ï¸ Finde largo: 15% OFF en combos seleccionados ğŸ›ï¸' }
  ];
  const t = `Veo ${list.length} evento(s) prÃ³ximo(s).`; $('#resp').textContent=t; speak(t);
  list.forEach(x=>{ renderActions([{ label:`ğŸ“£ ${x.event} (${x.date})`, href: buildWaLink(wa, x.messageSuggested) }]); });
}
function handleTickets_demo(){
  $('#resp').textContent = 'Buscando tickets de hoy...'; $('#actions').innerHTML='';
  const list = [{ name:'Carla', phone:'5491111122233', amount:'15000', textSuggested:'Â¡Gracias, Carla! Registramos tu compra de $15000. Sumaste puntos en FideLink. ğŸ™Œ' }];
  $('#resp').textContent = `Tengo ${list.length} ticket(s).`; speak(`Tengo ${list.length} tickets.`);
  list.forEach(x=>{ renderActions([{ label:`ğŸ§¾ Confirmar de ${x.name} $${x.amount}`, href: buildWaLink(x.phone, x.textSuggested) }]); });
}

/*** Router principal: intenta API NLU y si falla usa demo ***/
async function routeCommand(raw){
  const api = $('#api').value.trim();
  const q = (raw||'').trim();
  if (!q){ $('#resp').textContent='Decime algoâ€¦'; return; }

  if (api){
    try{
      const r = await fetch(api, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'nlu_route', query:q})});
      const data = await r.json();
      if (data && data.ok){
        const reply = data.reply || 'Listo.';
        $('#resp').textContent = reply; speak(reply);
        renderActions((data.actions||[]).map(a=>({label:a.label, href:a.href})));
        return;
      }
    }catch(e){ /* fallo API â†’ demo */ }
  }

  // HeurÃ­stica local simple
  const low = q.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  if (/cumple/.test(low)) return handleCumples_demo();
  if (/promo|oferta|feriado|patria|semana/.test(low)) return handlePromos_demo();
  if (/ticket|comprobante|compra/.test(low)) return handleTickets_demo();

  const m = low.match(/agradec.*a\s+([a-zÃ±Ã¡Ã©Ã­Ã³Ãº ]+)\s+por\s+(\d+(?:[.,]\d+)?)/i);
  if (m){ const nombre = cap(m[1]); const monto = m[2].replace(',', '.'); return handleAgradecimiento_local(nombre, monto); }

  const help = 'PodÃ©s decir: "Â¿QuiÃ©n cumple hoy?", "Â¿QuÃ© promos esta semana?", "Recibiste tickets hoy?", o "Enviar agradecimiento a Ana por 15000".';
  $('#resp').textContent = help; speak(help); $('#actions').innerHTML='';
}
function cap(s){ return String(s||'').trim().replace(/\s+/g,' ').replace(/\b\p{L}/gu, c=>c.toUpperCase()); }
function handleAgradecimiento_local(nombre, monto){
  const wa = $('#wa').value; const msg = `Â¡Gracias, ${nombre}! Registramos tu compra de $${monto}. Sumaste puntos en FideLink. ğŸ™Œ`;
  $('#resp').textContent = 'Listo. TocÃ¡ para enviar.'; speak('Listo. PreparÃ© el mensaje.');
  renderActions([{ label:`ğŸ’š Agradecer a ${nombre}`, href: buildWaLink(wa, msg) }]);
}

/*** Utilidades comunes ***/
function buildWaLink(phoneOrEmpty, text){ const p=digits(phoneOrEmpty); return p ? `https://wa.me/${p}?text=${enc(text)}` : `https://api.whatsapp.com/send?text=${enc(text)}`; }

/*** ============== SUGERIDOR (con Rubros) ============== ***/
/** Plantillas base por tipo + especializaciÃ³n por rubro */
const RUBRO_TEMPLATES = {
  generico: {
    amigo: (c)=> `ğŸ‘¯â€â™€ï¸ Â¡DÃ­a del Amigo! ${c.emoji||'ğŸ'} ${c.descuento||'15% OFF'} en ${c.producto||'combos seleccionados'} solo el ${c.fecha||''}.`,
    madre: (c)=> `ğŸŒ· DÃ­a de la Madre: ${c.descuento||'15% OFF'} en ${c.producto||'regalos'} hasta ${c.fin||c.fecha||''}. ${c.emoji||'ğŸ'}`,
    finde: (c)=> `ğŸ—“ï¸ Finde largo: ${c.descuento||'15% OFF'} en ${c.producto||'combos'} hasta el ${c.fin||c.fecha||''}. ${c.emoji||'ğŸ›ï¸'}`
  },
  panaderia: {
    amigo: (c)=> `ğŸ¥–ğŸ‘¯â€â™€ï¸ DÃ­a del Amigo: 2x1 en medialunas y facturas ${c.emoji||'ğŸ‰'} solo el ${c.fecha||''}.`,
    madre: (c)=> `ğŸ¥ğŸŒ· Especial MamÃ¡: box desayuno con ${c.descuento||'10% OFF'} hasta ${c.fin||c.fecha||''}.`,
    finde: (c)=> `ğŸ¥¯ Finde largo: promos en panes + budines ${c.descuento||'15% OFF'} ${c.emoji||'ğŸ›ï¸'}`
  },
  indumentaria: {
    amigo: (c)=> `ğŸ‘šğŸ‘• DÃ­a del Amigo: 2x1 en remeras ${c.emoji||'ğŸ'} solo el ${c.fecha||''}.`,
    madre: (c)=> `ğŸ‘—ğŸŒ· MamÃ¡ con estilo: ${c.descuento||'20% OFF'} en vestidos hasta ${c.fin||c.fecha||''}.`,
    finde: (c)=> `ğŸ‘œ Finde largo: ${c.descuento||'15% OFF'} en accesorios ${c.emoji||'ğŸ›ï¸'}`
  },
  gastronomia: {
    amigo: (c)=> `ğŸ•ğŸ‘¯â€â™€ï¸ DÃ­a del Amigo: 2x1 en pizzas ${c.emoji||'ğŸ‰'} solo el ${c.fecha||''}.`,
    madre: (c)=> `ğŸ°ğŸŒ· Especial MamÃ¡: postres con ${c.descuento||'15% OFF'} hasta ${c.fin||c.fecha||''}.`,
    finde: (c)=> `ğŸ Finde largo: combos familiares ${c.descuento||'15% OFF'} ${c.emoji||'ğŸ›ï¸'}`
  },
  electronica: {
    amigo: (c)=> `ğŸ§ğŸ‘¯â€â™€ï¸ DÃ­a del Amigo: ${c.descuento||'10% OFF'} en auriculares ${c.emoji||'ğŸ”Š'} solo el ${c.fecha||''}.`,
    madre: (c)=> `ğŸ“±ğŸŒ· MamÃ¡ tech: ${c.descuento||'15% OFF'} en smartphones hasta ${c.fin||c.fecha||''}.`,
    finde: (c)=> `ğŸ’» Finde largo: accesorios ${c.descuento||'15% OFF'} ${c.emoji||'ğŸ›ï¸'}`
  },
  peluqueria: {
    amigo: (c)=> `âœ‚ï¸ğŸ‘¯â€â™€ï¸ DÃ­a del Amigo: 2x1 en brushing ${c.emoji||'ğŸ'} solo el ${c.fecha||''}.`,
    madre: (c)=> `ğŸ’‡â€â™€ï¸ğŸŒ· MamÃ¡: ${c.descuento||'15% OFF'} en color y corte hasta ${c.fin||c.fecha||''}.`,
    finde: (c)=> `ğŸ’… Finde largo: combos uÃ±as + cejas ${c.descuento||'15% OFF'} ${c.emoji||'ğŸ›ï¸'}`
  },
  farmacia: {
    amigo: (c)=> `ğŸ§´ğŸ‘¯â€â™€ï¸ DÃ­a del Amigo: ${c.descuento||'10% OFF'} en dermocosmÃ©tica ${c.emoji||'ğŸ’„'} solo el ${c.fecha||''}.`,
    madre: (c)=> `ğŸŒ· Cuidado para MamÃ¡: ${c.descuento||'15% OFF'} en fragancias hasta ${c.fin||c.fecha||''}.`,
    finde: (c)=> `ğŸ©º Finde largo: botiquÃ­n + protecciÃ³n solar ${c.descuento||'15% OFF'}`
  },
  fitness: {
    amigo: (c)=> `ğŸ‹ï¸â€â™€ï¸ğŸ‘¯â€â™€ï¸ DÃ­a del Amigo: 2x1 en pases diarios ${c.emoji||'ğŸ”¥'} solo el ${c.fecha||''}.`,
    madre: (c)=> `ğŸ§˜â€â™€ï¸ğŸŒ· MamÃ¡ activa: ${c.descuento||'20% OFF'} en clases hasta ${c.fin||c.fecha||''}.`,
    finde: (c)=> `âš½ Finde largo: equipamiento ${c.descuento||'15% OFF'} ${c.emoji||'ğŸ›ï¸'}`
  },
  libreria: {
    amigo: (c)=> `ğŸ“˜ğŸ‘¯â€â™€ï¸ DÃ­a del Amigo: 2x1 en cuadernos ${c.emoji||'ğŸ'} solo el ${c.fecha||''}.`,
    madre: (c)=> `ğŸ“šğŸŒ· Lecturas para MamÃ¡: ${c.descuento||'15% OFF'} hasta ${c.fin||c.fecha||''}.`,
    finde: (c)=> `âœï¸ Finde largo: kits escolares ${c.descuento||'15% OFF'}`
  },
  servicios: {
    amigo: (c)=> `ğŸ§©ğŸ‘¯â€â™€ï¸ DÃ­a del Amigo: ${c.descuento||'15% OFF'} en tu servicio ${c.emoji||'ğŸ'} solo el ${c.fecha||''}.`,
    madre: (c)=> `ğŸ› ï¸ğŸŒ· MamÃ¡: ${c.descuento||'20% OFF'} en mantenimiento/asesorÃ­a hasta ${c.fin||c.fecha||''}.`,
    finde: (c)=> `ğŸ—“ï¸ Finde largo: paquetes ${c.descuento||'15% OFF'} ${c.emoji||'ğŸ›ï¸'}`
  },
  mascotas: {
    amigo: (c)=> `ğŸ¶ğŸ‘¯â€â™€ï¸ DÃ­a del Amigo (de 4 patas): 2x1 en snacks ${c.emoji||'ğŸ‰'} solo el ${c.fecha||''}.`,
    madre: (c)=> `ğŸ¾ğŸŒ· Especial MamÃ¡ Pet: ${c.descuento||'15% OFF'} en accesorios hasta ${c.fin||c.fecha||''}.`,
    finde: (c)=> `ğŸ± Finde largo: arena + alimentos ${c.descuento||'15% OFF'}`
  }
};

// Fallback genÃ©rico para cumpleaÃ±os / feriado
const FL_TEMPLATES = {
  'cumple': (ctx)=> `ğŸ‰ Â¡Feliz cumple, ${ctx.nombre||'cliente'}! ${ctx.emoji||'ğŸ’š'} Te esperamos con un mimo especial. VÃ¡lido hoy ${ctx.fecha||''}.`,
  'feriado_gen': (ctx)=> `ğŸ“£ ${ctx.evento||'Promo especial'} ${ctx.emoji||'ğŸ›ï¸'}\nAprovechÃ¡ ${ctx.descuento||'un beneficio especial'} hasta ${ctx.fin||ctx.fecha||'la fecha indicada'}.`
};

function openAutoTemplateModal(payload){
  const { tipo='feriado', ctx={}, titulo='Sugerencia de mensaje' } = payload||{};
  const rb = $('#rubro').value || 'generico';
  // mapeo tipo â†’ clave rubro
  const key = tipo==='amigo' ? 'amigo' : tipo==='madre' ? 'madre' : 'finde';
  const rubSet = RUBRO_TEMPLATES[rb] || RUBRO_TEMPLATES.generico;
  const tplFn = rubSet[key] || FL_TEMPLATES['feriado_gen'];
  const sugerido = tplFn(ctx);

  const el = document.createElement('div');
  el.style = 'position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:16px;z-index:9999';
  el.innerHTML = `
    <div class="card" style="max-width:700px;width:100%;background:#0f172a">
      <div class="pill">${titulo} Â· Rubro: ${rb}</div>
      <div class="row">
        <label>Mensaje propuesto (editable)</label>
        <textarea id="at_msg" rows="5">${sugerido}</textarea>
        <div class="row" style="grid-template-columns:auto auto auto">
          <button class="btn" id="at_ok">âœ… OK, generar WhatsApp</button>
          <button class="btn sec" id="at_copy">ğŸ“‹ Copiar texto</button>
          <button class="btn warn" id="at_cancel">Cerrar</button>
        </div>
        <small class="muted">Tip: podÃ©s agregar emojis y precios antes de tocar â€œOKâ€.</small>
        <div id="at_out" class="muted"></div>
      </div>
    </div>
  `;
  document.body.appendChild(el);
  const $$ = (s)=> el.querySelector(s);
  $$('#at_cancel').onclick = ()=> el.remove();
  $$('#at_copy').onclick = ()=>{ const t = $$('#at_msg').value; navigator.clipboard.writeText(t).then(()=>{$$('#at_out').textContent='Copiado âœ…';}); };
  $$('#at_ok').onclick = ()=>{
    const msg = $$('#at_msg').value.trim();
    if(!msg){ $$('#at_out').textContent='EscribÃ­ un mensaje.'; return; }
    const wa = ($('#wa')?.value||'').replace(/\D/g,'');
    const href = wa ? `https://wa.me/${wa}?text=${encodeURIComponent(msg)}` : `https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`;
    const box = $('#actions');
    const div = document.createElement('div'); div.className='item';
    const a = document.createElement('a'); a.className='btn'; a.target='_blank'; a.rel='noopener';
    a.href = href; a.textContent = 'ğŸ“² Abrir WhatsApp y enviar';
    div.appendChild(a); box.prepend(div);
    $('#resp').textContent = 'Listo. PreparÃ© el mensaje. TocÃ¡ el botÃ³n para enviarlo.';
    el.remove();
  };
}

function suggestFromUpcoming(evento, fechaISO){
  // detectar tipo segÃºn nombre del evento
  const name = (evento||'').toLowerCase();
  let tipo = 'finde';
  if (name.includes('amig')) tipo='amigo';
  else if (name.includes('madre')) tipo='madre';
  openAutoTemplateModal({ titulo:`Sugerencia para: ${evento}`, tipo, ctx:{ evento, fecha: fechaISO, descuento:'15% OFF', producto:'combos', emoji:'ğŸ›ï¸' } });
}
function suggestBirthday(nombre){
  // Para cumple uso plantilla global (no por rubro)
  const msg = FL_TEMPLATES.cumple({ nombre, fecha: new Date().toISOString().slice(0,10), emoji:'ğŸ‚' });
  const el = document.createElement('div');
  el.style = 'position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:16px;z-index:9999';
  el.innerHTML = `
    <div class="card" style="max-width:700px;width:100%;background:#0f172a">
      <div class="pill">Saludo cumple: ${nombre}</div>
      <div class="row">
        <textarea id="at_msg" rows="5">${msg}</textarea>
        <div class="row" style="grid-template-columns:auto auto auto">
          <button class="btn" id="ok">âœ… OK, generar WhatsApp</button>
          <button class="btn sec" id="cp">ğŸ“‹ Copiar texto</button>
          <button class="btn warn" id="cl">Cerrar</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(el);
  const $$ = s=> el.querySelector(s);
  $$('#cl').onclick=()=>el.remove();
  $$('#cp').onclick=()=>{ const t=$$('#at_msg').value; navigator.clipboard.writeText(t); };
  $$('#ok').onclick=()=>{
    const t = $$('#at_msg').value.trim();
    const wa = ($('#wa')?.value||'').replace(/\D/g,'');
    const href = wa ? `https://wa.me/${wa}?text=${encodeURIComponent(t)}` : `https://api.whatsapp.com/send?text=${encodeURIComponent(t)}`;
    const box = $('#actions'); const div = document.createElement('div'); div.className='item';
    const a = document.createElement('a'); a.className='btn'; a.target='_blank'; a.rel='noopener'; a.href = href; a.textContent = 'ğŸ“² Abrir WhatsApp y enviar';
    div.appendChild(a); box.prepend(div); $('#resp').textContent='Listo. PreparÃ© el mensaje. TocÃ¡ para enviar.'; el.remove();
  };
}

/*** Render de acciones: agrega botÃ³n â€œğŸ¤– Sugerirâ€ para promos/cumples ***/
function renderActions(items){
  const box = document.querySelector('#actions'); box.innerHTML='';
  (items||[]).forEach(it=>{
    const wrap = document.createElement('div'); wrap.className='item';
    const a = document.createElement('a'); a.className='btn'; a.href=it.href; a.target='_blank'; a.rel='noopener';
    a.textContent = it.label; wrap.appendChild(a);

    // PROMO: label "ğŸ“£ Evento (YYYY-MM-DD)"
    const mPromo = /^ğŸ“£\s+(.+?)\s+\((\d{4}-\d{2}-\d{2})\)/.exec(it.label || '');
    if (mPromo){
      const btn = document.createElement('button'); btn.className='btn sec'; btn.style.marginLeft='8px';
      btn.textContent = 'ğŸ¤– Sugerir mensaje'; btn.onclick = ()=> suggestFromUpcoming(mPromo[1], mPromo[2]); wrap.appendChild(btn);
    }
    // CUMPLE: label "ğŸ‚ Saludar a NOMBRE"
    const mCumple = /^ğŸ‚\s+Saludar a\s+(.+)/.exec(it.label || '');
    if (mCumple){
      const btn = document.createElement('button'); btn.className='btn sec'; btn.style.marginLeft='8px';
      btn.textContent = 'ğŸ¤– Sugerir saludo'; btn.onclick = ()=> suggestBirthday(mCumple[1]); wrap.appendChild(btn);
    }
    box.appendChild(wrap);
  });
}

/*** Promos locales (sin Sheets) â€” crear/editar/borrar + guardar opcional ***/
const promosMem = JSON.parse(localStorage.getItem(LS.promos)||'[]');
function renderPromos(){
  const box = $('#promoBox');
  if(!promosMem.length){ box.innerHTML = 'No hay promos cargadas aÃºn.'; return; }
  box.innerHTML = '';
  promosMem.forEach((p,i)=>{
    const prev = [`ğŸ—“ï¸ ${p.fecha} â€” ${p.titulo}`, p.mensaje].join('\n');
    const wa = buildWaLink($('#wa').value, p.mensaje);
    const card = document.createElement('div'); card.className='item';
    card.innerHTML = `
      <div class="out" style="margin-bottom:8px">${prev.replaceAll('\n','<br>')}</div>
      <div class="row" style="grid-template-columns:auto auto auto">
        <a class="btn" target="_blank" rel="noopener" href="${wa}">ğŸ“² Enviar por WhatsApp</a>
        <button class="btn warn" data-i="${i}">ğŸ—‘ï¸ Borrar</button>
        <button class="btn" data-edit="${i}">âœï¸ Editar</button>
      </div>`;
    card.querySelector('[data-i]').onclick = (e)=>{ const idx=+e.currentTarget.getAttribute('data-i'); promosMem.splice(idx,1); localStorage.setItem(LS.promos, JSON.stringify(promosMem)); renderPromos(); };
    card.querySelector('[data-edit]').onclick = (e)=>{ const idx=+e.currentTarget.getAttribute('data-edit'); openPromoCreator(promosMem[idx], idx); };
    box.appendChild(card);
  });
}
function openPromoCreator(existing=null, index=null){
  const modal = document.createElement('div');
  modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:16px;z-index:9999';
  modal.innerHTML = `
    <div class="card" style="max-width:680px;width:100%;background:#0f172a">
      <div class="pill">${existing ? 'Editar promo' : 'Crear promo'}</div>
      <div class="row">
        <label>Fecha (AAAA-MM-DD)</label>
        <input id="pp_fecha" placeholder="2025-07-20" value="${existing?.fecha||''}">
        <label>TÃ­tulo</label>
        <input id="pp_titulo" placeholder="Ej: DÃ­a del Amigo 2x1" value="${existing?.titulo||''}">
        <label>Mensaje (con emojis)</label>
        <textarea id="pp_mensaje" rows="4" placeholder="ğŸ‘¯â€â™€ï¸ Promo DÃ­a del Amigo: 2x1 en picadas ğŸ§€ğŸ‰">${existing?.mensaje||''}</textarea>
        <div class="row" style="grid-template-columns:auto auto auto">
          <button class="btn" id="pp_preview">ğŸ‘€ Vista previa</button>
          <button class="btn sec" id="pp_save">${existing?'ğŸ’¾ Guardar cambios':'âœ… Guardar'}</button>
          <button class="btn warn" id="pp_cancel">Cerrar</button>
        </div>
        <div id="pp_out" class="muted" style="margin-top:8px"></div>
      </div>
    </div>`;
  document.body.appendChild(modal);
  $('#pp_cancel').onclick = ()=> modal.remove();
  $('#pp_preview').onclick = ()=>{ const o=getPromoForm(); $('#pp_out').innerText=`ğŸ—“ï¸ ${o.fecha} â€” ${o.titulo}\n${o.mensaje}`; };
  $('#pp_save').onclick = ()=>{
    const o=getPromoForm();
    if(!o.fecha || !/^\d{4}-\d{2}-\d{2}$/.test(o.fecha)){ alert('Fecha invÃ¡lida. UsÃ¡ AAAA-MM-DD.'); return; }
    if(!o.titulo || !o.mensaje){ alert('CompletÃ¡ tÃ­tulo y mensaje.'); return; }
    if(index!=null){ promosMem[index] = o; } else { promosMem.unshift(o); }
    localStorage.setItem(LS.promos, JSON.stringify(promosMem)); renderPromos();
    savePromoServer(o).catch(()=>{}); modal.remove();
  };
  function getPromoForm(){ return { fecha:($('#pp_fecha').value||'').trim(), titulo:($('#pp_titulo').value||'').trim(), mensaje:($('#pp_mensaje').value||'').trim() }; }
}
async function savePromoServer(o){
  const api = $('#api').value.trim(); if(!api) return;
  try{ await fetch(api, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'promos_crear', data:o }) }); }catch(e){}
}
$('#btnNewPromo').addEventListener('click', ()=> openPromoCreator());
renderPromos();
</script>
</body>
</html>
