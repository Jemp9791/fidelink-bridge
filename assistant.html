<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FideLink Assistant</title>
<meta name="theme-color" content="#0ea5e9"/>
<style>
  :root{--bg:#0b1020;--card:#0f172a;--border:#1f2a44;--ink:#e2e8f0;--mut:#94a3b8}
  *{box-sizing:border-box} body{font-family:system-ui,Roboto,Segoe UI,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
  .wrap{max-width:960px;margin:0 auto;padding:20px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin:12px 0}
  .title{display:flex;align-items:center;gap:12px}
  .pill{display:inline-block;background:#1f2a44;color:#cbd5e1;border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
  .row{display:grid;gap:10px}
  .row2{grid-template-columns:1fr 1fr}
  .row3{grid-template-columns:1fr 1fr 1fr}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1329;color:var(--ink)}
  .btn{background:#38bdf8;color:#00131a;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
  .btn.sec{background:#10b981;color:#052}
  .btn.warn{background:#f59e0b;color:#210}
  .mic{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border-radius:999px;border:0;background:#10b981;color:#042;cursor:pointer;font-weight:800}
  .mic.rec{background:#f59e0b;color:#120}
  .muted{color:var(--mut);font-size:12px}
  .out{white-space:pre-wrap}
  .item{padding:12px;border:1px solid var(--border);border-radius:12px;margin-bottom:10px}
  .actions{display:grid;gap:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <img alt="Logo" width="36" height="36" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect width='100%' height='100%' rx='8' fill='%231f2a44'/><text x='50%' y='58%' text-anchor='middle' font-family='Arial' font-size='14' fill='%23cbd5e1'>FL</text></svg>"/>
    <h1 style="margin:0">FideLink ‚Äî Assistant</h1>
    <span class="pill">Pro</span>
  </div>

  <!-- Config -->
  <div class="card">
    <div class="row row3">
      <div>
        <label>API URL (tu Web App /exec)</label>
        <input id="api" placeholder="https://script.google.com/macros/s/AKfycbwBZlmUKaOZRXKoP5lerRXsDkRMVPaJ1k7z4NcpBY1HNbA8JkmDUA2DjsoZfH_exILPDw/exec"/>
        <small class="muted">Si est√° vac√≠o o falla, usa <b>modo demo</b>.</small>
      </div>
      <div>
        <label>WhatsApp del comercio (solo d√≠gitos)</label>
        <input id="wa" placeholder="54911..."/>
      </div>
      <div>
        <label>Rubro</label>
        <select id="rubro">
          <option value="generico">Gen√©rico</option>
          <option value="panaderia">Panader√≠a</option>
          <option value="indumentaria">Indumentaria</option>
          <option value="gastronomia">Gastronom√≠a</option>
          <option value="electronica">Electr√≥nica</option>
          <option value="peluqueria">Peluquer√≠a/Est√©tica</option>
          <option value="farmacia">Farmacia</option>
          <option value="fitness">Fitness/Deportes</option>
          <option value="libreria">Librer√≠a/Regaler√≠a</option>
          <option value="servicios">Servicios</option>
          <option value="mascotas">Mascotas</option>
        </select>
      </div>
    </div>
    <div class="row row2" style="margin-top:10px">
      <div>
        <label>Idioma</label>
        <select id="lang">
          <option value="es-AR">Espa√±ol (AR)</option>
          <option value="es-ES">Espa√±ol (ES)</option>
          <option value="pt-BR">Portugu√™s (BR)</option>
        </select>
      </div>
      <div>
        <label>Acceso r√°pido</label>
        <div class="row" style="grid-template-columns:1fr 1fr">
          <button id="btnMic" class="mic">üé§ Hablar</button>
          <button id="btnClear" class="btn warn">üßπ Limpiar</button>
        </div>
      </div>
    </div>
    <div style="margin-top:10px">
      <label>Entrada por texto</label>
      <div class="row" style="grid-template-columns:1fr auto">
        <input id="textIn" placeholder='Ej: "¬øQui√©n cumple hoy?" / "¬øQu√© promos esta semana?" / "Enviar agradecimiento a Ana por 15000"'/>
        <button id="btnSend" class="btn">‚ñ∂Ô∏è Enviar</button>
      </div>
      <div class="muted" id="hint">Sugerencias: ‚Äú¬øQui√©n cumple hoy?‚Äù, ‚Äú¬øQu√© promos esta semana?‚Äù, ‚ÄúRecibiste tickets hoy?‚Äù, ‚ÄúEnviar agradecimiento a Ana por 15000‚Äù.</div>
    </div>
  </div>

  <!-- Vistas -->
  <div class="card"><div class="pill">Lo que dijiste/escribiste</div><div id="heard" class="out">‚Äî</div></div>
  <div class="card"><div class="pill">Respuesta</div><div id="resp" class="out">‚Äî</div></div>
  <div class="card"><div class="pill">Acciones</div><div id="actions" class="actions"></div></div>

  <!-- Promos locales (sin Sheets) -->
  <div class="card">
    <div class="pill">Promos</div>
    <div class="actions">
      <button class="btn sec" id="btnNewPromo">‚ûï Crear promo</button>
    </div>
    <div id="promoBox" class="out muted">No hay promos cargadas a√∫n.</div>
  </div>

  <p class="muted">Tip: ‚ÄúAgregar a pantalla de inicio‚Äù para usarlo como app.</p>
</div>

<script>
/*** ===== Persistencia b√°sica ===== ***/
const $ = s=>document.querySelector(s);
const enc = encodeURIComponent;
const digits = s=> String(s||'').replace(/\D/g,'');
const LS = { api:'fl_api', wa:'fl_wa', lang:'fl_lang', rubro:'fl_rubro', promos:'fl_promos' };
$('#api').value = localStorage.getItem(LS.api)||'';
$('#wa').value = localStorage.getItem(LS.wa)||'';
$('#lang').value = localStorage.getItem(LS.lang)||'es-AR';
$('#rubro').value = localStorage.getItem(LS.rubro)||'generico';
$('#api').addEventListener('input', ()=>localStorage.setItem(LS.api, $('#api').value.trim()));
$('#wa').addEventListener('input', ()=>localStorage.setItem(LS.wa, digits($('#wa').value)));
$('#lang').addEventListener('change',()=>localStorage.setItem(LS.lang,$('#lang').value));
$('#rubro').addEventListener('change',()=>localStorage.setItem(LS.rubro,$('#rubro').value));

/*** ===== Cargar perfil desde la API (lee hoja Configuraci√≥n) ===== ***/
async function loadBusinessProfile(){
  const api=$('#api').value.trim(); if(!api) return;
  try{
    const r=await fetch(api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'business_profile'})});
    const d=await r.json(); if(!d?.ok) return;
    if(d.profile?.wa){ $('#wa').value=String(d.profile.wa); localStorage.setItem(LS.wa,String(d.profile.wa)); }
    if(d.profile?.rubro){ $('#rubro').value=d.profile.rubro; localStorage.setItem(LS.rubro,d.profile.rubro); }
    if(d.profile?.nombre){ document.title=`FideLink ‚Äî ${d.profile.nombre}`; const h1=document.querySelector('h1'); if(h1) h1.textContent=d.profile.nombre+' ‚Äî Assistant'; }
    if(d.profile?.logo_url){ const img=document.querySelector('.title img'); if(img) img.src=d.profile.logo_url; }
    window.FL_PROFILE=d.profile||{}; window.FL_TEMPLATES_BASE=d.templates||{};
  }catch(e){}
}
loadBusinessProfile();
$('#api').addEventListener('change', loadBusinessProfile);

/*** ===== Voz ===== ***/
const speak = (t)=>{ try{ const u=new SpeechSynthesisUtterance(t); u.lang=$('#lang').value||'es-AR'; speechSynthesis.speak(u);}catch(e){} };

/*** ===== Mic ===== ***/
let rec=null;
function startRec(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ alert('Tu navegador no soporta micr√≥fono. Prob√° Chrome Android o Safari iPhone.'); return; }
  rec=new SR(); rec.lang=$('#lang').value||'es-AR'; rec.interimResults=false; rec.maxAlternatives=1;
  $('#btnMic').classList.add('rec'); $('#heard').textContent='Escuchando...';
  rec.onresult=(e)=>{ const txt=e.results[0][0].transcript; $('#heard').textContent=txt; routeCommand(txt); };
  rec.onerror =()=>{ $('#heard').textContent='No te escuch√©. Prob√° de nuevo.'; $('#btnMic').classList.remove('rec'); };
  rec.onend =()=> $('#btnMic').classList.remove('rec');
  rec.start();
}
$('#btnMic').addEventListener('click', startRec);
$('#btnClear').addEventListener('click', ()=>{ $('#heard').textContent='‚Äî'; $('#resp').textContent='‚Äî'; $('#actions').innerHTML=''; });
$('#btnSend').addEventListener('click', ()=>{ const t=$('#textIn').value.trim(); if(!t) return; $('#heard').textContent=t; routeCommand(t); });
$('#textIn').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#btnSend').click(); } });

/*** ===== Acciones ===== ***/
function renderActions(items){
  const box=$('#actions'); box.innerHTML='';
  (items||[]).forEach(it=>{
    const wrap=document.createElement('div'); wrap.className='item';
    const a=document.createElement('a'); a.className='btn'; a.href=it.href; a.target='_blank'; a.rel='noopener'; a.textContent=it.label; wrap.appendChild(a);
    // Detectar promos: "üì£ Evento (YYYY-MM-DD)"
    const mPromo=/^üì£\s+(.+?)\s+\((\d{4}-\d{2}-\d{2})\)/.exec(it.label||'');
    if(mPromo){ const b=document.createElement('button'); b.className='btn sec'; b.style.marginLeft='8px'; b.textContent='ü§ñ Sugerir mensaje'; b.onclick=()=>suggestFromUpcoming(mPromo[1],mPromo[2]); wrap.appendChild(b); }
    // Detectar cumple: "üéÇ Saludar a NOMBRE"
    const mCumple=/^üéÇ\s+Saludar a\s+(.+)/.exec(it.label||'');
    if(mCumple){ const b=document.createElement('button'); b.className='btn sec'; b.style.marginLeft='8px'; b.textContent='ü§ñ Sugerir saludo'; b.onclick=()=>suggestBirthday(mCumple[1]); wrap.appendChild(b); }
    box.appendChild(wrap);
  });
}
function buildWaLink(phoneOrEmpty, text){ const p=digits(phoneOrEmpty); return p?`https://wa.me/${p}?text=${enc(text)}`:`https://api.whatsapp.com/send?text=${enc(text)}`; }

/*** ===== Router principal ===== ***/
async function routeCommand(raw){
  const api=$('#api').value.trim(); const q=(raw||'').trim(); if(!q){ $('#resp').textContent='Decime algo‚Ä¶'; return; }
  if(api){
    try{
      const r=await fetch(api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'nlu_route',query:q})});
      const d=await r.json();
      if(d?.ok){ const reply=d.reply||'Listo.'; $('#resp').textContent=reply; speak(reply); renderActions((d.actions||[]).map(a=>({label:a.label,href:a.href}))); return; }
    }catch(e){}
  }
  // Fallback demo
  const low=q.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  if(/cumple/.test(low)) return handleCumples_demo();
  if(/promo|oferta|feriado|semana/.test(low)) return handlePromos_demo();
  if(/ticket|comprobante|compra/.test(low)) return handleTickets_demo();

  const m=low.match(/agradec.*a\s+([a-z√±√°√©√≠√≥√∫ ]+)\s+por\s+(\d+(?:[.,]\d+)?)/i);
  if(m){ const nombre=cap(m[1]); const monto=m[2].replace(',','.'); return handleAgradecimiento_local(nombre,monto); }
  const help='Pod√©s decir: "¬øQui√©n cumple hoy?", "¬øQu√© promos esta semana?", "Recibiste tickets hoy?", o "Enviar agradecimiento a Ana por 15000".';
  $('#resp').textContent=help; speak(help); $('#actions').innerHTML='';
}
function cap(s){ return String(s||'').trim().replace(/\s+/g,' ').replace(/\b\p{L}/gu,c=>c.toUpperCase()); }

/*** ===== DEMO handlers ===== ***/
function handleCumples_demo(){
  $('#resp').textContent='Buscando cumplea√±eros de hoy...'; $('#actions').innerHTML='';
  const list=[{name:'Ana P√©rez',phone:'5491112345678',textSuggested:'üéâ ¬°Feliz cumple, Ana! Te esperamos con un mimo especial.'}];
  const t=`Hoy cumplen: ${list.map(x=>x.name).join(', ')}.`; $('#resp').textContent=t; speak(t);
  list.forEach(x=> renderActions([{label:`üéÇ Saludar a ${x.name}`, href: buildWaLink(x.phone,x.textSuggested)}]) );
}
function handlePromos_demo(){
  $('#resp').textContent='Revisando pr√≥ximas promociones y feriados...'; $('#actions').innerHTML='';
  const wa=$('#wa').value; const list=[{event:'D√≠a del Amigo',date:'2025-07-20',messageSuggested:'üëØ‚Äç‚ôÄÔ∏è 2x1 en picadas üßÄüéâ'}];
  const t=`Veo ${list.length} evento(s) pr√≥ximo(s).`; $('#resp').textContent=t; speak(t);
  list.forEach(x=> renderActions([{label:`üì£ ${x.event} (${x.date})`, href: buildWaLink(wa,x.messageSuggested)}]) );
}
function handleTickets_demo(){
  $('#resp').textContent='Buscando tickets de hoy...'; $('#actions').innerHTML='';
  const x={name:'Carla',phone:'5491111122233',amount:'15000',textSuggested:'¬°Gracias, Carla! Registramos tu compra de $15000. Sumaste puntos en FideLink. üôå'};
  $('#resp').textContent='Tengo 1 ticket.'; speak('Tengo un ticket.'); renderActions([{label:`üßæ Confirmar de ${x.name} $${x.amount}`, href: buildWaLink(x.phone,x.textSuggested)}]);
}
function handleAgradecimiento_local(nombre,monto){
  const wa=$('#wa').value; const msg=`¬°Gracias, ${nombre}! Registramos tu compra de $${monto}. Sumaste puntos en FideLink. üôå`;
  $('#resp').textContent='Listo. Toc√° para enviar.'; speak('Listo. Prepar√© el mensaje.'); renderActions([{label:`üíö Agradecer a ${nombre}`, href: buildWaLink(wa,msg)}]);
}

/*** ===== Sugeridor con rubro (plantillas) ===== ***/
const RUBRO_TEMPLATES = {
  generico:{ amigo:c=>`üëØ‚Äç‚ôÄÔ∏è D√≠a del Amigo: ${c.descuento||'15% OFF'} en ${c.producto||'combos'} solo el ${c.fecha||''}.`,
             madre:c=>`üå∑ D√≠a de la Madre: ${c.descuento||'15% OFF'} en ${c.producto||'regalos'} hasta ${c.fin||c.fecha||''}.`,
             finde:c=>`üóìÔ∏è Finde largo: ${c.descuento||'15% OFF'} en ${c.producto||'combos'} hasta ${c.fin||c.fecha||''}.` },
  panaderia:{ amigo:c=>`ü•ñüëØ‚Äç‚ôÄÔ∏è D√≠a del Amigo: 2x1 en medialunas ${c.fecha||''}.`, madre:c=>`ü•êüå∑ Desayuno para Mam√°: ${c.descuento||'10% OFF'} hasta ${c.fin||c.fecha||''}.`, finde:c=>`ü•Ø Finde: panes + budines ${c.descuento||'15% OFF'}` },
  indumentaria:{ amigo:c=>`üëö D√≠a del Amigo: 2x1 en remeras ${c.fecha||''}.`, madre:c=>`üëóüå∑ Mam√°: ${c.descuento||'20% OFF'} en vestidos.`, finde:c=>`üëú Finde: ${c.descuento||'15% OFF'} en accesorios.` },
  gastronomia:{ amigo:c=>`üçïüëØ‚Äç‚ôÄÔ∏è Amigo: 2x1 en pizzas ${c.fecha||''}.`, madre:c=>`üç∞üå∑ Mam√°: postres ${c.descuento||'15% OFF'}.`, finde:c=>`üçù Finde largo: combos familiares ${c.descuento||'15% OFF'}.` },
  electronica:{ amigo:c=>`üéß Amigo: ${c.descuento||'10% OFF'} en auriculares ${c.fecha||''}.`, madre:c=>`üì±üå∑ Mam√° tech: ${c.descuento||'15% OFF'} en smartphones.`, finde:c=>`üíª Finde: accesorios ${c.descuento||'15% OFF'}.` },
  peluqueria:{ amigo:c=>`‚úÇÔ∏è Amigo: 2x1 en brushing ${c.fecha||''}.`, madre:c=>`üíá‚Äç‚ôÄÔ∏èüå∑ Mam√°: ${c.descuento||'15% OFF'} en color y corte.`, finde:c=>`üíÖ Finde: combos u√±as + cejas ${c.descuento||'15% OFF'}.` },
  farmacia:{ amigo:c=>`üß¥ Amigo: ${c.descuento||'10% OFF'} en dermocosm√©tica.`, madre:c=>`üå∑ Fragancias ${c.descuento||'15% OFF'}.`, finde:c=>`ü©∫ Botiqu√≠n ${c.descuento||'15% OFF'}.` },
  fitness:{ amigo:c=>`üèãÔ∏è‚Äç‚ôÄÔ∏è Amigo: 2x1 en pases diarios.`, madre:c=>`üßò‚Äç‚ôÄÔ∏è Mam√° activa: ${c.descuento||'20% OFF'} en clases.`, finde:c=>`‚öΩ Finde: equipamiento ${c.descuento||'15% OFF'}.` },
  libreria:{ amigo:c=>`üìò Amigo: 2x1 en cuadernos.`, madre:c=>`üìö Mam√°: ${c.descuento||'15% OFF'} en libros.`, finde:c=>`‚úèÔ∏è Finde: kits escolares ${c.descuento||'15% OFF'}.` },
  servicios:{ amigo:c=>`üß© Amigo: ${c.descuento||'15% OFF'} en tu servicio.`, madre:c=>`üõ†Ô∏è Mam√°: ${c.descuento||'20% OFF'} en mantenimiento.`, finde:c=>`üóìÔ∏è Finde: paquetes ${c.descuento||'15% OFF'}.` },
  mascotas:{ amigo:c=>`üê∂ Amigo peludo: 2x1 en snacks.`, madre:c=>`üêæ Mam√° Pet: ${c.descuento||'15% OFF'} en accesorios.`, finde:c=>`üê± Finde: arena + alimentos ${c.descuento||'15% OFF'}.` }
};
function appendFirma(msg){
  const base=(window.FL_TEMPLATES_BASE?.firma||'').trim(); if(!base) return msg;
  const p=(window.FL_PROFILE||{}); const rep=base.replace('{NEGOCIO}',p.nombre||'').replace('{HORARIO}',p.horario||'').replace('{DIRECCION}',p.direccion||'').replace('{WA}',p.wa||'');
  return `${msg}\n\n${rep}`;
}
function openAutoTemplateModal(payload){
  const { tipo='finde', ctx={}, titulo='Sugerencia de mensaje' } = payload||{};
  const rb=$('#rubro').value||'generico'; const tpl=(RUBRO_TEMPLATES[rb]||RUBRO_TEMPLATES.generico)[tipo]||RUBRO_TEMPLATES.generico.finde;
  const sugerido=appendFirma(tpl(ctx));
  const el=document.createElement('div'); el.style='position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:16px;z-index:9999';
  el.innerHTML=`<div class="card" style="max-width:700px;width:100%;background:#0f172a">
    <div class="pill">${titulo} ¬∑ Rubro: ${rb}</div>
    <div class="row">
      <label>Mensaje propuesto (editable)</label>
      <textarea id="at_msg" rows="5">${sugerido}</textarea>
      <div class="row" style="grid-template-columns:auto auto auto">
        <button class="btn" id="at_ok">‚úÖ OK, generar WhatsApp</button>
        <button class="btn sec" id="at_copy">üìã Copiar texto</button>
        <button class="btn warn" id="at_cancel">Cerrar</button>
      </div>
      <div id="at_out" class="muted"></div>
    </div></div>`;
  document.body.appendChild(el);
  const $$=s=>el.querySelector(s);
  $$('#at_cancel').onclick=()=>el.remove();
  $$('#at_copy').onclick=()=>{ const t=$$('#at_msg').value; navigator.clipboard.writeText(t).then(()=>{$$('#at_out').textContent='Copiado ‚úÖ';}); };
  $$('#at_ok').onclick=()=>{
    const msg=$$('#at_msg').value.trim(); if(!msg){ $$('#at_out').textContent='Escrib√≠ un mensaje.'; return; }
    const wa=($('#wa')?.value||'').replace(/\D/g,''); const href=wa?`https://wa.me/${wa}?text=${encodeURIComponent(msg)}`:`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`;
    const box=$('#actions'); const div=document.createElement('div'); div.className='item';
    const a=document.createElement('a'); a.className='btn'; a.target='_blank'; a.rel='noopener'; a.href=href; a.textContent='üì≤ Abrir WhatsApp y enviar';
    div.appendChild(a); box.prepend(div); $('#resp').textContent='Listo. Prepar√© el mensaje. Toc√° el bot√≥n para enviarlo.'; el.remove();
  };
}
function suggestFromUpcoming(evento, fechaISO){
  const name=(evento||'').toLowerCase(); let tipo='finde'; if(name.includes('amig')) tipo='amigo'; else if(name.includes('madre')) tipo='madre';
  openAutoTemplateModal({ titulo:`Sugerencia para: ${evento}`, tipo, ctx:{ evento, fecha:fechaISO, descuento:'15% OFF', producto:'combos' } });
}
function suggestBirthday(nombre){
  const base=`üéâ ¬°Feliz cumple, ${nombre}! Te esperamos con un mimo especial.`; openAutoTemplateModal({ titulo:`Saludo cumple: ${nombre}`, tipo:'finde', ctx:{}, }); // reutilizo modal editable
  setTimeout(()=>{ const t=document.querySelector('#at_msg'); if(t){ t.value=appendFirma(base); } },50);
}

/*** ===== Promos locales (crear/editar sin Sheets) ===== ***/
const promosMem=JSON.parse(localStorage.getItem(LS.promos)||'[]');
function renderPromos(){
  const box=$('#promoBox'); if(!promosMem.length){ box.innerHTML='No hay promos cargadas a√∫n.'; return; }
  box.innerHTML=''; promosMem.forEach((p,i)=>{ const prev=`üóìÔ∏è ${p.fecha} ‚Äî ${p.titulo}\n${p.mensaje}`; const wa=buildWaLink($('#wa').value,p.mensaje);
    const card=document.createElement('div'); card.className='item';
    card.innerHTML=`<div class="out" style="margin-bottom:8px">${prev.replaceAll('\n','<br>')}</div>
      <div class="row" style="grid-template-columns:auto auto auto">
        <a class="btn" target="_blank" rel="noopener" href="${wa}">üì≤ Enviar por WhatsApp</a>
        <button class="btn warn" data-i="${i}">üóëÔ∏è Borrar</button>
        <button class="btn" data-edit="${i}">‚úèÔ∏è Editar</button></div>`;
    card.querySelector('[data-i]').onclick=e=>{ const idx=+e.currentTarget.getAttribute('data-i'); promosMem.splice(idx,1); localStorage.setItem(LS.promos,JSON.stringify(promosMem)); renderPromos(); };
    card.querySelector('[data-edit]').onclick=e=>{ const idx=+e.currentTarget.getAttribute('data-edit'); openPromoCreator(promosMem[idx],idx); };
    box.appendChild(card);
  });
}
function openPromoCreator(existing=null,index=null){
  const modal=document.createElement('div'); modal.style='position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:16px;z-index:9999';
  modal.innerHTML=`<div class="card" style="max-width:680px;width:100%;background:#0f172a"><div class="pill">${existing?'Editar promo':'Crear promo'}</div>
    <div class="row"><label>Fecha (AAAA-MM-DD)</label><input id="pp_fecha" placeholder="2025-07-20" value="${existing?.fecha||''}">
      <label>T√≠tulo</label><input id="pp_titulo" placeholder="Ej: D√≠a del Amigo 2x1" value="${existing?.titulo||''}">
      <label>Mensaje (con emojis)</label><textarea id="pp_mensaje" rows="4" placeholder="üëØ‚Äç‚ôÄÔ∏è Promo D√≠a del Amigo: 2x1 en picadas üßÄüéâ">${existing?.mensaje||''}</textarea>
      <div class="row" style="grid-template-columns:auto auto auto"><button class="btn" id="pp_preview">üëÄ Vista previa</button>
      <button class="btn sec" id="pp_save">${existing?'üíæ Guardar':'‚úÖ Guardar'}</button><button class="btn warn" id="pp_cancel">Cerrar</button></div>
      <div id="pp_out" class="muted" style="margin-top:8px"></div></div></div>`;
  document.body.appendChild(modal);
  $('#pp_cancel').onclick=()=>modal.remove();
  $('#pp_preview').onclick=()=>{ const o=getPromoForm(); $('#pp_out').innerText=`üóìÔ∏è ${o.fecha} ‚Äî ${o.titulo}\n${o.mensaje}`; };
  $('#pp_save').onclick=()=>{ const o=getPromoForm(); if(!o.fecha||!/^\d{4}-\d{2}-\d{2}$/.test(o.fecha)) return alert('Fecha inv√°lida AAAA-MM-DD');
    if(!o.titulo||!o.mensaje) return alert('Complet√° t√≠tulo y mensaje.'); if(index!=null) promosMem[index]=o; else promosMem.unshift(o);
    localStorage.setItem(LS.promos,JSON.stringify(promosMem)); renderPromos(); savePromoServer(o).catch(()=>{}); modal.remove(); };
  function getPromoForm(){ return {fecha:($('#pp_fecha').value||'').trim(), titulo:($('#pp_titulo').value||'').trim(), mensaje:($('#pp_mensaje').value||'').trim()}; }
}
async function savePromoServer(o){ const api=$('#api').value.trim(); if(!api) return;
  try{ await fetch(api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'promos_crear',data:o})}); }catch(e){} }
$('#btnNewPromo').addEventListener('click', ()=> openPromoCreator());
renderPromos();
</script>
</body>
</html>
