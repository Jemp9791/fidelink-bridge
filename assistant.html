<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FideLink Assistant</title>
<link rel="icon" href="data:,">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0f172a;color:#e5e7eb;margin:0}
  .wrap{max-width:920px;margin:24px auto;padding:16px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:16px;margin:12px 0}
  label{display:block;font-size:13px;color:#9ca3af;margin-bottom:6px}
  input,select,button{width:100%;padding:10px;border-radius:12px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
  button{cursor:pointer;font-weight:600}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .actions a{display:inline-block;margin:6px 6px 0 0;padding:10px 12px;border-radius:12px;border:1px solid #374151;color:#e5e7eb;text-decoration:none}
  .muted{color:#9ca3af;font-size:12px}
  h1{font-size:28px;margin:8px 0 12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>FideLink Assistant <span class="muted">Beta</span></h1>

  <div class="card">
    <div class="row">
      <div>
        <label>API URL (tu Web App /exec)</label>
        <input id="apiUrl" placeholder="https://script.google.com/macros/s/AKfycbz9n6lOcxyIbbm8j_PeUc208y-tWW-lMFKv_je2VWBDWHyDkMY9dS9V2cEpUyr9KuhfIQ/exec"/>
      </div>
      <div>
        <label>Idioma de voz</label>
        <select id="lang">
          <option value="es-AR">Espa√±ol (AR)</option>
          <option value="es-ES">Espa√±ol (ES)</option>
          <option value="pt-BR">Portugu√™s (BR)</option>
        </select>
      </div>
    </div>
    <div class="muted" style="margin-top:8px">
      Consejo: a√±ad√≠ esta p√°gina a la <b>pantalla de inicio</b> para usarla como app.
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label>Comandos por voz o texto</label>
        <button id="btnMic">üé§ Hablar</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <input id="text" placeholder='Ej.: "¬øQui√©n cumple hoy?", "Enviar agradecimiento a Ana por 15000"' />
      </div>
    </div>
    <div style="margin-top:10px" class="row">
      <div>
        <label>Lo que dijiste</label>
        <div id="heard" class="card" style="min-height:38px"></div>
      </div>
      <div>
        <label>Respuesta</label>
        <div id="reply" class="card" style="min-height:38px"></div>
      </div>
    </div>
    <div class="actions" id="actions"></div>
  </div>

  <div class="card">
    <label>Perfil del negocio detectado</label>
    <div id="profile" class="muted">‚Äî</div>
  </div>
</div>

<script>
/* ====== Cargar/guardar API y Sheet ID ====== */
const urlObj = new URL(location.href);
const qSheet = urlObj.searchParams.get('sheet') || '';
if (qSheet) localStorage.setItem('FIDELINK_SHEET_ID', qSheet);
const SHEET_ID = localStorage.getItem('FIDELINK_SHEET_ID') || ''; // <- queda guardado

const inputApi = document.querySelector('#apiUrl');
inputApi.value = localStorage.getItem('FIDELINK_API_URL') || '';
inputApi.addEventListener('change', () => localStorage.setItem('FIDELINK_API_URL', inputApi.value.trim()));

/* ====== Llamar al backend (siempre con sheet_id) ====== */
async function callApi(payload){
  const url = (localStorage.getItem('FIDELINK_API_URL') || inputApi.value || '').trim();
  if (!url) throw new Error('Falta API URL (/exec).');
  const body = Object.assign({}, payload, { sheet_id: SHEET_ID });
  const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  return await res.json();
}

/* ====== UI ====== */
const heard = v => document.querySelector('#heard').textContent = v||'‚Äî';
const say = v => document.querySelector('#reply').textContent = v||'‚Äî';
const actDiv= document.querySelector('#actions');

function setActions(list){
  actDiv.innerHTML = '';
  (list||[]).forEach(a=>{
    const el = document.createElement('a');
    el.textContent = a.label || 'Acci√≥n';
    el.href = a.href || 'javascript:void(0)';
    el.target = '_blank';
    actDiv.appendChild(el);
  });
}

async function refreshProfile(){
  try{
    const r = await callApi({ action:'business_profile' });
    if (!r.ok) throw new Error(r.error||'error');
    document.querySelector('#profile').textContent =
      `${r.negocio.nombre||'(sin nombre)'} ‚Ä¢ ${r.negocio.rubro||'-'} ‚Ä¢ WA ${r.negocio.wa||'-'}`;
  }catch(err){
    document.querySelector('#profile').textContent = 'No pude leer el perfil. Revis√° API_URL y sheet_id.';
  }
}
refreshProfile();

/* ====== NLU (texto) ====== */
document.querySelector('#text').addEventListener('keydown', async (e)=>{
  if (e.key !== 'Enter') return;
  const query = e.target.value.trim();
  if (!query) return;
  heard(query); say('‚Ä¶');
  try{
    const r = await callApi({ action:'nlu_route', query });
    if (!r.ok) throw new Error(r.error||'error');
    say(r.reply || 'Listo.');
    setActions(r.actions);
  }catch(err){ say('No pude procesar. Revis√° conexi√≥n / API_URL.'); }
});

/* ====== Voz (si el navegador soporta) ====== */
document.querySelector('#btnMic').addEventListener('click', ()=>{
  try{
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return alert('Tu navegador no soporta reconocimiento de voz.');
    const rec = new SR(); rec.lang = document.querySelector('#lang').value || 'es-AR';
    rec.onresult = ev => {
      const txt = ev.results[0][0].transcript || '';
      document.querySelector('#text').value = txt;
      const e = new KeyboardEvent('keydown', { key:'Enter' });
      document.querySelector('#text').dispatchEvent(e);
    };
    rec.start();
  }catch(e){ alert('No pude iniciar el micr√≥fono.'); }
});
</script>
</body>
</html>
