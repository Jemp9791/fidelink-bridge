<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FideLink Assistant</title>
<meta name="theme-color" content="#0ea5e9"/>
<style>
  body{font-family:system-ui,Roboto,Segoe UI,Arial,sans-serif;margin:0;background:#0b1020;color:#e2e8f0}
  .wrap{max-width:820px;margin:0 auto;padding:20px}
  .card{background:#0f172a;border:1px solid #1f2a44;border-radius:16px;padding:18px;margin:12px 0}
  .title{display:flex;align-items:center;gap:12px}
  .mic{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border-radius:999px;border:0;background:#10b981;color:#042;cursor:pointer;font-weight:800}
  .mic.rec{background:#f59e0b;color:#120}
  .row{display:grid;gap:10px}
  .row2{grid-template-columns:1fr 1fr}
  .btn{background:#38bdf8;color:#00131a;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
  .pill{display:inline-block;background:#1f2a44;color:#cbd5e1;border-radius:999px;padding:4px 10px;font-size:12px;margin-right:6px}
  .out{white-space:pre-wrap}
  .item{padding:12px;border:1px solid #1f2a44;border-radius:12px}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1329;color:#e2e8f0}
  .muted{opacity:.8;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect width='100%' height='100%' rx='8' fill='%231f2a44'/><text x='50%' y='58%' text-anchor='middle' font-family='Arial' font-size='14' fill='%23cbd5e1'>FL</text></svg>" alt="FideLink" />
    <h1 style="margin:0">FideLink Assistant</h1>
    <span class="pill">Beta</span>
  </div>

  <div class="card">
    <div class="row row2">
      <div>
        <label>Número de WhatsApp del comercio</label>
        <input id="wa" placeholder="54911..." inputmode="numeric" />
      </div>
      <div>
        <label>Idioma de voz</label>
        <select id="lang">
          <option value="es-AR">Español (AR)</option>
          <option value="es-ES">Español (ES)</option>
          <option value="pt-BR">Português (BR)</option>
        </select>
      </div>
    </div>
    <div style="margin-top:12px">
      <button id="btnMic" class="mic">🎤 Hablar</button>
      <span class="muted" id="hint">Decí: “¿Quién cumple hoy?”, “¿Qué promos esta semana?”, “Enviar agradecimiento a Ana por 15000”.</span>
    </div>
  </div>

  <div class="card">
    <div class="pill">Lo que dijiste</div>
    <div id="heard" class="out">—</div>
  </div>

  <div class="card">
    <div class="pill">Respuesta</div>
    <div id="resp" class="out">—</div>
  </div>

  <div class="card">
    <div class="pill">Acciones</div>
    <div id="actions" class="row"></div>
  </div>

  <p class="muted">Consejo: “Agregar a pantalla de inicio” para usarlo como app.</p>
</div>

<script>
/** CONFIGURA TU API (Apps Script Web App) **/
const API_URL = 'https://script.google.com/macros/s/AKfycby_cuFEKoDYwl8Rrvq_fHu9FRJlwr6cnzx160KKDcKvA44CmG2vmC2btc1yeyCv3073nw/exec'; // ← pega tu URL
const $ = s => document.querySelector(s);
const enc = encodeURIComponent;
const digits = s => (s||'').replace(/\D/g,'');
const speak = (text) => { try{ const u = new SpeechSynthesisUtterance(text); u.lang = $('#lang').value || 'es-AR'; speechSynthesis.speak(u);}catch(e){} };


const LS = { wa:'fl_wa', lang:'fl_lang' };
$('#wa').value = localStorage.getItem(LS.wa)||'';
$('#lang').value = localStorage.getItem(LS.lang)||'es-AR';
$('#wa').addEventListener('input', ()=>localStorage.setItem(LS.wa, digits($('#wa').value)));
$('#lang').addEventListener('change', ()=>localStorage.setItem(LS.lang, $('#lang').value));

/** Reconocimiento de voz (push‑to‑talk) **/
let rec=null;
function startRec(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ alert('Este navegador no soporta reconocimiento de voz. Usá Chrome en Android o Safari en iPhone.'); return; }
  rec = new SR();
  rec.lang = $('#lang').value || 'es-AR';
  rec.interimResults = false;
  rec.maxAlternatives = 1;
  $('#btnMic').classList.add('rec');
  $('#heard').textContent = 'Escuchando...';
  rec.onresult = (e)=>{
    const txt = e.results[0][0].transcript;
    $('#heard').textContent = txt;
    routeCommand(txt);
  };
  rec.onerror = ()=>{ $('#heard').textContent = 'No te escuché. Probá de nuevo.'; $('#btnMic').classList.remove('rec'); };
  rec.onend = ()=>$('#btnMic').classList.remove('rec');
  rec.start();
}
$('#btnMic').addEventListener('click', startRec);

/** Router de comandos naturales (simple y eficaz) **/
async function routeCommand(raw){
  const q = (raw||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();

  // Intents básicos
  if (/quien(es)? cumple/.test(q) || /cumplean/.test(q)){
    return handleCumples();
  }
  if (/promo/.test(q) || /oferta/.test(q) || /feriado/.test(q) || /patria/.test(q) || /semana/.test(q)){
    return handlePromos();
  }
  if (/ticket|comprobante|compra/.test(q)){
    return handleTickets();
  }
  // “enviar agradecimiento a Ana por 15000”
  const m = q.match(/agradecimiento.*a\s+([a-záéíóúñ ]+)\s+por\s+(\d+(?:[.,]\d+)?)/i);
  if (m){
    const nombre = m[1].trim();
    const monto  = m[2].replace(',', '.');
    return handleAgradecimiento(nombre, monto);
  }

  // fallback ayuda
  const help = 'Podés decir: "¿Quién cumple hoy?", "¿Qué promos esta semana?", "Recibiste tickets hoy?", "Enviar agradecimiento a Ana por 15000".';
  $('#resp').textContent = help; speak(help);
  $('#actions').innerHTML = '';
}

/** Handlers: llaman al backend y crean botones de WhatsApp **/
async function handleCumples(){
  $('#resp').textContent = 'Buscando cumpleañeros de hoy...'; $('#actions').innerHTML='';
  try{
    const res = await fetch(API_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'cumples_hoy'})});
    const data = await res.json();
    const list = data?.items || []; // espera [{name, phone, textSuggested}]
    if(!list.length){ const t='Hoy no hay cumpleañeros.'; $('#resp').textContent=t; speak(t); return; }
    const t = `Hoy cumplen: ${list.map(x=>x.name).join(', ')}.`;
    $('#resp').textContent = t; speak(t);
    renderActions(list.map(x=>({
      label: `🎂 Saludar a ${x.name}`,
      href: buildWaLink(x.phone, x.textSuggested || `¡Feliz cumple, ${x.name}! 🎉 Te esperamos con un mimo especial.`)
    })));
  }catch(e){ fail(e); }
}

async function handlePromos(){
  $('#resp').textContent = 'Revisando próximas promociones y feriados...'; $('#actions').innerHTML='';
  try{
    const res = await fetch(API_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'promos_proximas'})});
    const data = await res.json();
    const list = data?.items || []; // [{event, date, messageSuggested}]
    if(!list.length){ const t='No hay promos próximas configuradas.'; $('#resp').textContent=t; speak(t); return; }
    const t = `Veo ${list.length} evento(s) próximo(s).`;
    $('#resp').textContent = t; speak(t);
    renderActions(list.map(x=>({
      label: `📣 ${x.event} (${x.date})`,
      href: buildWaLink($('#wa').value, x.messageSuggested || `Promo especial por ${x.event}. ¿Querés que te cuente?`)
    })));
  }catch(e){ fail(e); }
}

async function handleTickets(){
  $('#resp').textContent = 'Buscando tickets de hoy...'; $('#actions').innerHTML='';
  try{
    const res = await fetch(API_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'tickets_hoy'})});
    const data = await res.json();
    const list = data?.items || []; // [{name, phone, amount, textSuggested}]
    if(!list.length){ const t='Hoy no hay tickets pendientes.'; $('#resp').textContent=t; speak(t); return; }
    $('#resp').textContent = `Tengo ${list.length} ticket(s).`; speak(`Tengo ${list.length} tickets.`);
    renderActions(list.map(x=>({
      label: `🧾 Confirmar de ${x.name} $${x.amount}`,
      href: buildWaLink(x.phone, x.textSuggested || `¡Gracias, ${x.name}! Registramos tu compra de $${x.amount}.`)
    })));
  }catch(e){ fail(e); }
}

async function handleAgradecimiento(nombre, monto){
  $('#resp').textContent = `Armando agradecimiento para ${nombre} por $${monto}...`; $('#actions').innerHTML='';
  // si tu backend calcula puntos/nivel, podés pedirlo aquí
  const msg = `¡Gracias, ${nombre}! Registramos tu compra de $${monto}. Sumaste puntos en FideLink. 🙌`;
  $('#resp').textContent = 'Listo. Tocá para enviar.';
  renderActions([{ label:`💚 Agradecer a ${nombre}`, href: buildWaLink($('#wa').value, msg) }]);
  speak('Listo. Preparé el mensaje.');
}

/** Utils UI **/
function buildWaLink(phoneOrEmpty, text){
  const p = digits(phoneOrEmpty);
  if (p) return `https://wa.me/${p}?text=${enc(text)}`;
  return `https://api.whatsapp.com/send?text=${enc(text)}`;
}
function renderActions(items){
  const box = $('#actions'); box.innerHTML='';
  items.forEach(it=>{
    const a = document.createElement('a'); a.className='btn'; a.href=it.href; a.target='_blank'; a.rel='noopener'; a.textContent=it.label;
    const div = document.createElement('div'); div.className='item'; div.appendChild(a);
    box.appendChild(div);
  });
}
function fail(e){ const t='No pude consultar los datos. Revisá tu conexión o API_URL.'; $('#resp').textContent=t; speak(t); console.error(e); }
</script>
</body>
</html>
